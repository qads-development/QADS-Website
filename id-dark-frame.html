<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://js.qads.cloud/v3/src/id/frame.js">
    <title>QADS Security Widget</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: transparent;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        .widget-container {
            background-color: #0f132a;
            border: 1px solid #1e293b; 
            border-radius: 6px;        
            width: 300px;
            height: 65px;
            display: flex;
            align-items: center;
            padding: 0 12px;
            box-sizing: border-box;
            position: relative;
            justify-content: space-between;
        }

        .status-wrapper {
            display: none;
            align-items: center;
            gap: 12px;
            height: 100%;
            flex-grow: 1;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid #1e293b;
            border-top: 2px solid #6c5ce7; 
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-icon {
            display: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            animation: popIn 0.3s ease-out;
        }

        .status-icon.success { background-color: #6c5ce7; }
        .status-icon.failure { background-color: #ff4757; }

        .icon-symbol {
            color: #fff;
            font-size: 16px;
            font-weight: bold;
        }

        @keyframes popIn {
            0% { transform: scale(0); }
            80% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .status-text {
            font-size: 14px;
            color: #e2e8f0; 
            font-weight: 500;
            cursor: default;
        }

        #checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        .custom-checkbox {
            width: 24px;
            height: 24px;
            background-color: #0f132a; 
            border: 2px solid #475569; 
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .custom-checkbox:hover { border-color: #94a3b8; }

        .checkbox-label {
            font-size: 14px;
            color: #e2e8f0;
            cursor: pointer;
        }

        .logo-wrapper {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            justify-content: center;
            margin-left: 10px;
        }

        .brand-text {
            font-size: 9px;
            color: #64748b; 
        }

        .brand-text a {
            color: #64748b;
            text-decoration: none;
        }
        .brand-text a:hover { text-decoration: underline; color: #94a3b8; }

    </style>
</head>
<body>

    <div class="widget-container">
        
        <div class="status-wrapper" id="auto-ui">
            <div class="spinner" id="spinner"></div>

            <div class="status-icon success" id="icon-success">
                <span class="icon-symbol">✓</span>
            </div>

            <div class="status-icon failure" id="icon-failure">
                <span class="icon-symbol">✕</span>
            </div>

            <span class="status-text" id="main-text">Verifying...</span>
        </div>

        <div id="checkbox-wrapper">
            <div class="custom-checkbox" id="manual-check-box"></div>
            <span class="checkbox-label" id="manual-check-label">Verify your connection</span>
        </div>

        <div class="logo-wrapper">
            <img src="qads.png" alt="QADS" class="custom-logo-img" onerror="this.style.display='none'"> 
            <div class="brand-text">
                <a href="https://qads.cloud/" target="_blank">QADS.cloud</a>
            </div>
        </div>

    </div>

    <script>
        const content = {
            en: {
                verifyLabel: "Verify your connection",
                verifying: "Verifying...",
                success: "Connection verified",
                blocked: "Connection blocked, try again."
            },
            fr: {
                verifyLabel: "Vérifier votre connection",
                verifying: "Vérification...",
                success: "Connexion vérifiée",
                blocked: "Réessayez"
            }
        };

        const userLang = navigator.language || navigator.userLanguage; 
        const lang = (userLang && userLang.toLowerCase().startsWith('fr')) ? 'fr' : 'en';
        const txt = content[lang];

        const SecuritySystem = {
            score: 0,
            checkAll: function() {
                this.score = 0;
                if (navigator.webdriver) this.score += 100;
                const ua = navigator.userAgent.toLowerCase();
                if (['headless', 'bot', 'crawl', 'spider'].some(b => ua.includes(b))) this.score += 100;
                if (window.outerWidth === 0 || window.innerWidth === 0) this.score += 50;
                if (!navigator.plugins || navigator.plugins.length === 0) this.score += 10;
                return this.score;
            }
        };

        const autoUI = document.getElementById('auto-ui');
        const checkboxUI = document.getElementById('checkbox-wrapper');
        const spinner = document.getElementById('spinner');
        const successIcon = document.getElementById('icon-success');
        const failIcon = document.getElementById('icon-failure');
        const mainText = document.getElementById('main-text');
        
        const manualCheckbox = document.getElementById('manual-check-box');
        const manualLabel = document.getElementById('manual-check-label');

        manualLabel.innerText = txt.verifyLabel;
        mainText.innerText = txt.verifying;

        function toggleParentForms(enable) {
            try {
                if (window.parent === window) return;
                const forms = window.parent.document.forms;
                for (let i = 0; i < forms.length; i++) {
                    const btns = forms[i].querySelectorAll('button[type="submit"], input[type="submit"]');
                    btns.forEach(btn => btn.disabled = !enable);
                }
            } catch (e) {
                console.warn('Cross-origin restriction: Use postMessage to disable parent form.');
            }
        }

        function showSuccess() {
            spinner.style.display = 'none';
            successIcon.style.display = 'flex';
            mainText.innerText = txt.success;
            mainText.style.color = "#a29bfe"; 
            
            checkboxUI.style.display = 'none';
            autoUI.style.display = 'flex';

            toggleParentForms(true);

            window.parent.postMessage({
                action: 'QADS_VERIFY_SUCCESS',
                token: 'VERIFIED_TRUE'
            }, '*');
        }

        function showFailure() {
            checkboxUI.style.display = 'none';
            autoUI.style.display = 'flex'; 
            spinner.style.display = 'none';
            failIcon.style.display = 'flex';
            mainText.innerText = txt.blocked;
            mainText.style.color = "#ff7675";
            toggleParentForms(false);
        }

        function triggerSoftFail() {
            autoUI.style.display = 'none';
            checkboxUI.style.display = 'flex';

            const verifyAction = () => {
                checkboxUI.style.display = 'none';
                autoUI.style.display = 'flex';
                spinner.style.display = 'block';
                mainText.innerText = txt.verifying;
                mainText.style.color = "#e2e8f0"; 

                setTimeout(showSuccess, 4000);
            };

            manualCheckbox.addEventListener('click', verifyAction);
            manualLabel.addEventListener('click', verifyAction);
        }

        window.addEventListener('load', () => {
            toggleParentForms(false);
            const score = SecuritySystem.checkAll();

            if (score >= 100) {
                showFailure();
            } else {
                triggerSoftFail();
            }
        });

    </script>
</body>
</html>
